<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Ghost Rooms | Anonymous Vibes</title>

<style>
  :root {
    --bg: #050505;
    --accent: #ff4d6d; /* Soft Ghost Pink */
    --me: #ff4d6d;
    --them: rgba(255, 255, 255, 0.1);
    --glass: rgba(255, 255, 255, 0.05);
    --text: #ffffff;
    --muted: rgba(255, 255, 255, 0.5);
  }

  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    background-image: radial-gradient(circle at 50% -20%, #221111 0%, #050505 80%);
    color: var(--text);
    overflow: hidden;
  }

  .screen {
    display: none;
    height: 100dvh;
    padding: 24px;
    box-sizing: border-box;
    animation: fadeIn 0.5s ease;
  }

  .active { display: flex; flex-direction: column; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  h2 { font-weight: 800; letter-spacing: -1px; margin-bottom: 8px; font-size: 2rem; }
  .tagline { color: var(--muted); margin-bottom: 40px; font-size: 0.9rem; }

  /* Buttons */
  button {
    padding: 16px;
    background: var(--glass);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    cursor: pointer;
    transition: 0.3s;
    backdrop-filter: blur(10px);
  }

  button:active { transform: scale(0.98); background: var(--accent); }

  .primary-btn { background: var(--accent); border: none; }

  /* Chat Area */
  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px 0;
    display: flex;
    flex-direction: column;
    scrollbar-width: none;
  }
  #messages::-webkit-scrollbar { display: none; }

  .bubble {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 20px;
    margin-bottom: 12px;
    font-size: 15px;
    line-height: 1.4;
    position: relative;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

  .me {
    background: var(--accent);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }

  .them {
    background: var(--them);
    backdrop-filter: blur(5px);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  .system {
    align-self: center;
    font-size: 11px;
    color: var(--muted);
    background: transparent;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Input Area */
  .input-wrapper {
    display: flex;
    gap: 10px;
    padding: 10px 0;
    background: var(--bg);
  }

  input {
    flex: 1;
    padding: 14px 20px;
    border-radius: 30px;
    border: 1px solid rgba(255,255,255,0.1);
    background: var(--glass);
    color: white;
    font-size: 16px;
    outline: none;
  }

  input:focus { border-color: var(--accent); }

  /* Room Info */
  .room-info {
    font-size: 12px;
    padding: 8px;
    text-align: center;
    color: var(--muted);
    border-bottom: 1px solid var(--glass);
  }
</style>
</head>

<body>

<div id="home" class="screen active">
  <div style="margin-top: auto;">
    <h2>üëª Ghost Rooms</h2>
    <p class="tagline">Voices that vanish. Secrets that stay.</p>
    
    <button class="primary-btn" data-type="private">Create Private Room</button>
    <button data-type="community">Join Community Vibe</button>
  </div>
</div>

<div id="chat" class="screen">
  <div class="room-info" id="roomLink">Tap to copy secret invite link üîó</div>
  <div id="messages"></div>

  <form id="chatForm" class="input-wrapper">
    <input id="messageInput" placeholder="Whisper into the void‚Ä¶" maxlength="240" autocomplete="off" />
    <button style="margin:0; width: 60px; border-radius: 50%;"><i class="fas fa-paper-plane"></i> ‚Üí</button>
  </form>
</div>

<div id="expired" class="screen">
  <div style="margin: auto; text-align: center;">
    <h1 style="font-size: 4rem;">üå´Ô∏è</h1>
    <h2>Vibe Vanished</h2>
    <p class="tagline">This room has reached its end and dissolved into the digital mist.</p>
    <button class="primary-btn" onclick="location.href='index.html'">Start a New Life</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, getDoc, onSnapshot, query, orderBy, serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCEUDD0iB4iGFSDoC0a3wCXF8PT098Su3w",
    authDomain: "anonymous-messaging-f93c0.firebaseapp.com",
    projectId: "anonymous-messaging-f93c0",
    storageBucket: "anonymous-messaging-f93c0.firebasestorage.app",
    messagingSenderId: "990716606250",
    appId: "1:990716606250:web:a82a15347cc5980aa01053"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  await signInAnonymously(auth);
  const ghostUid = auth.currentUser.uid;

  const screens = {
    home: document.getElementById("home"),
    chat: document.getElementById("chat"),
    expired: document.getElementById("expired")
  };

  const messagesEl = document.getElementById("messages");
  const input = document.getElementById("messageInput");
  const form = document.getElementById("chatForm");
  const roomLinkBtn = document.getElementById("roomLink");

  function show(screen) {
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[screen].classList.add("active");
  }

  // Copy Link Feature
  roomLinkBtn.onclick = () => {
    navigator.clipboard.writeText(window.location.href);
    roomLinkBtn.textContent = "‚úÖ Link Copied! Share it wisely.";
    setTimeout(() => roomLinkBtn.textContent = "Invite link üîó", 3000);
  };

  // Create Room
  document.addEventListener("click", async e => {
    const type = e.target.dataset.type;
    if (!type) return;

    const hours = type === "private" ? 24 : 6;
    const now = Timestamp.now();

    const roomRef = await addDoc(collection(db, "rooms"), {
      type,
      createdAt: now,
      expiresAt: Timestamp.fromMillis(now.toMillis() + hours * 3600000)
    });

    window.location.hash = roomRef.id;
    initRoom(roomRef.id);
  });

  async function initRoom(roomId) {
    show("chat");
    const roomSnap = await getDoc(doc(db, "rooms", roomId));
    
    if (!roomSnap.exists()) return show("expired");

    // Expiry Check
    if (Timestamp.now().toMillis() > roomSnap.data().expiresAt.toMillis()) {
      return show("expired");
    }

    onSnapshot(
      query(collection(db, "rooms", roomId, "messages"), orderBy("createdAt")),
      snap => {
        // Only render new changes
        snap.docChanges().forEach(change => {
          if (change.type === "added") render(change.doc.data());
        });
      }
    );
  }

  form.onsubmit = async e => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    input.value = ""; // Clear immediately for snappiness
    
    await addDoc(collection(db, "rooms", location.hash.slice(1), "messages"), {
      text,
      senderUid: ghostUid,
      createdAt: serverTimestamp()
    });
  };

  function render(msg) {
    if (!msg.createdAt) return; // Prevent double rendering of local optimistic updates
    const div = document.createElement("div");
    div.className = "bubble " + (!msg.senderUid ? "system" : (msg.senderUid === ghostUid ? "me" : "them"));
    div.textContent = msg.text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  if (window.location.hash) {
    initRoom(window.location.hash.slice(1));
  }
</script>

</body>
</html>
